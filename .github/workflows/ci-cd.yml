name: CI/CD Full - Centinela (DevSecOps)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:

  setup-cache:
    name: Prepare & Cache (pip / npm)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache pip packages
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/services/**/requirements.txt') }}-${{ runner.os }}
          restore-keys: |
            pip-${{ runner.os }}
      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v4
        with:
          path: |
            services/frontend/node_modules
            ~/.npm
          key: node-${{ hashFiles('services/frontend/**/package-lock.json') }}-${{ runner.os }}
          restore-keys: |
            node-${{ runner.os }}

  lint-format-sast:
    name: Lint / Format / SAST
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install black flake8 bandit semgrep
      - run: black --check services
      - run: flake8 services
      - run: bandit -r services/api -lll
      - run: semgrep --config ./.semgrep/basic-rules.yml

  dependency-scan:
    name: Dependency & Filesystem Scan (Trivy SBOM)
    runs-on: ubuntu-latest
    needs: lint-format-sast
    steps:
      - uses: actions/checkout@v4
      - run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - run: trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress .

  tests:
    name: Unit & Smoke Tests
    runs-on: ubuntu-latest
    needs: dependency-scan
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV
      - run: |
          pip install -r services/api/requirements.txt
          pip install pytest
          pytest -q
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          cd services/frontend
          npm install
          npm run build --if-present

  build-and-scan-images:
    name: Build, Scan & Push Versioned Images
    runs-on: ubuntu-latest
    needs: tests
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }} # No se toca, esto funciona.
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        if: ${{ env.GHCR_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Build, scan and push images
        run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')

          API_IMG_ID="$REGISTRY/$IMAGE_NS/api:${{ github.run_id }}"
          FRONTEND_IMG_ID="$REGISTRY/$IMAGE_NS/frontend:${{ github.run_id }}"
          SCRAPER_IMG_ID="$REGISTRY/$IMAGE_NS/scraper:${{ github.run_id }}"

          docker build -t $API_IMG_ID -f services/api/Dockerfile services/api
          docker build -t $FRONTEND_IMG_ID -f services/frontend/Dockerfile services/frontend
          docker build -t $SCRAPER_IMG_ID -f services/scraper/Dockerfile services/scraper

          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          mkdir -p reports
          trivy --download-db-only || true

          # --- ¡AHORA FALLARÁ SI ENCUENTRA CVEs! ---
          trivy image --format json --output reports/trivy-api.json --severity HIGH,CRITICAL --exit-code 1 $API_IMG_ID
          trivy image --format json --output reports/trivy-frontend.json --severity HIGH,CRITICAL --exit-code 1 $FRONTEND_IMG_ID
          trivy image --format json --output reports/trivy-scraper.json --severity HIGH,CRITICAL --exit-code 1 $SCRAPER_IMG_ID

          docker push $API_IMG_ID
          docker push $FRONTEND_IMG_ID
          docker push $SCRAPER_IMG_ID

      # --- ¡CORRECCIÓN! Reportes de Trivy se suben AHORA ---
      - name: Upload Trivy reports
        if: always() # Subir reportes incluso si el 'step' anterior falló
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: reports/*.json
          if-no-files-found: ignore

  dast:
    name: DAST — OWASP ZAP
    runs-on: ubuntu-latest
    needs: build-and-scan-images
    # --- ¡CORRECCIÓN! Añadido if:always() ---
    # Queremos que DAST corra incluso si el job de build falla (por Trivy)
    if: always()
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
      IMAGE_TAG: ${{ github.run_id }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        if: ${{ env.GHCR_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Run application stack
        run: |
          export IMAGE_NAMESPACE=$(echo "${{ env.IMAGE_NAMESPACE }}" | tr '[:upper:]' '[:lower:]')
          export IMAGE_TAG=${{ env.IMAGE_TAG }}

          docker compose -f docker-compose.yml pull
          docker compose -f docker-compose.yml up -d && sleep 30

      - name: Run ZAP Baseline Scan
        continue-on-error: true # Lo dejamos en true para que genere reporte sin fallar
        run: |
          mkdir -p reports

          FRONTEND_CID=$(docker compose ps -q frontend)
          if [ -z "$FRONTEND_CID" ]; then
            echo "ERROR: no se encontró el contenedor 'frontend'"
            docker compose ps || true
            exit 1
          fi

          NETWORK_NAME=$(docker inspect --format '{{range $k,$v := .NetworkSettings.Networks}}{{$k}} {{end}}' $FRONTEND_CID | awk '{print $1}')
          echo "Conectando ZAP a la red: $NETWORK_NAME"

          echo "Esperando a que frontend responda en http://frontend:80..."
          REACHABLE=0
          for i in $(seq 1 12); do
            echo "Intento $i/12..."
            docker run --rm --network "$NETWORK_NAME" busybox wget -qO- http://frontend:80 >/dev/null 2>&1 && { REACHABLE=1; echo "frontend responde dentro de la red"; break; } || sleep 5
          done

          if [ "$REACHABLE" -ne 1 ]; then
            echo "WARNING: frontend no responde..."
            docker logs $FRONTEND_CID || true
          fi

          # --- ¡CORRECCIÓN! La ruta del reporte es RELATIVA ---
          docker run --rm \
            --network "$NETWORK_NAME" \
            --name zap_scanner \
            -v "$(pwd)/reports":/zap/wrk \
            ghcr.io/zaproxy/zaproxy zap-baseline.py \
              -t http://frontend:80 \
              -r report_dast_zap.html || true # -r es ahora 'report_dast_zap.html'

      # --- ¡ELIMINADO! 'Upload Trivy reports' se movió a 'build-and-scan-images' ---

      - name: Ensure ZAP report
        if: always()
        run: |
          echo "Listado de carpeta 'reports':"
          ls -la reports || true
          if [ -f reports/report_dast_zap.html ]; then
            echo "ZAP report encontrado: reports/report_dast_zap.html"
          else
            echo "ZAP report no encontrado"
          fi

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reporte-dast-zap
          path: reports/report_dast_zap.html
          if-no-files-found: ignore

      - name: Stop application stack
        if: always()
        run: docker compose -f docker-compose.yml down --volumes --remove-orphans

  publish-and-deploy:
    name: Publish ':latest' tags
    runs-on: ubuntu-latest
    needs: dast
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }} # No se toca, esto funciona.
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - name: Login GHCR
        if: ${{ env.GHCR_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          # --- ¡CORRECCIÓN DE NOMBRES! ---
          docker pull $REGISTRY/$IMAGE_NS/api:${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS/api:${{ github.run_id }} $REGISTRY/$IMAGE_NS/api:latest
          docker push $REGISTRY/$IMAGE_NS/api:latest
      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          # --- ¡CORRECCIÓN DE NOMBRES! ---
          docker pull $REGISTRY/$IMAGE_NS/frontend:${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS/frontend:${{ github.run_id }} $REGISTRY/$IMAGE_NS/frontend:latest
          docker push $REGISTRY/$IMAGE_NS/frontend:latest
      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          # --- ¡CORRECCIÓN DE NOMBRES! ---
          docker pull $REGISTRY/$IMAGE_NS/scraper:${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS/scraper:${{ github.run_id }} $REGISTRY/$IMAGE_NS/scraper:latest
          docker push $REGISTRY/$IMAGE_NS/scraper:latest

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: publish-and-deploy
    if: always()
    steps:
      - run: docker image prune -af || true
