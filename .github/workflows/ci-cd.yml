# ------------------------------------------------------------------
# Nombre del Workflow
# ------------------------------------------------------------------
name: CI/CD Full - Centinela (DevSecOps Optimized)

# ------------------------------------------------------------------
# Disparadores (Triggers)
# ------------------------------------------------------------------
on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

# ------------------------------------------------------------------
# Trabajos (Jobs)
# ------------------------------------------------------------------
jobs:

  # ------------------------------------------------------------------
  # Job 1: Preparar CachÃ© (Base para todos)
  # ------------------------------------------------------------------
  setup-cache:
    name: Prepare & Cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/services/**/requirements.txt') }}-${{ runner.os }}
          restore-keys: |
            pip-${{ runner.os }}
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            services/frontend/node_modules
            ~/.npm
          key: node-${{ hashFiles('services/frontend/**/package-lock.json') }}-${{ runner.os }}
          restore-keys: |
            node-${{ runner.os }}
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: .trivy
          key: trivy-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            trivy-db-${{ runner.os }}

  # ------------------------------------------------------------------
  # Job 2: Escaneo EstÃ¡tico (SAST)
  # ------------------------------------------------------------------
  lint-format-sast:
    name: Lint / Format / SAST
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install black flake8 bandit semgrep
      - run: black --check services
      - run: flake8 services --ignore=E501,W503,W291
      - run: bandit -r services/api -lll
      - run: semgrep --config ./.semgrep/basic-rules.yml

# ------------------------------------------------------------------
  # Job 3: Escaneo de Dependencias (SCA)
  # ------------------------------------------------------------------
  dependency-scan:
    name: Dependency Scan (Trivy Filesystem)
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Trivy
        run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Run Trivy FS Scan (ALL Severities - No Fail)
        # Cambio importante:
        # 1. Detecta TODO: UNKNOWN, LOW, MEDIUM, HIGH, CRITICAL
        # 2. exit-code 0: No rompe el pipeline, solo muestra los datos en el log.
        run: |
          trivy fs --cache-dir .trivy \
            --scanners vuln,secret \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --exit-code 0 \
            --no-progress .
  # ------------------------------------------------------------------
  # Job 4: Escaneo de Infraestructura (IaC)
  # ------------------------------------------------------------------
  iac-scan:
    name: IaC Scan (Checkov)
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Run Checkov scan
          uses: bridgecrewio/checkov-action@v12
          with:
            directory: ./terraform
            framework: terraform
            output_format: cli
            soft_fail: true 

  # ------------------------------------------------------------------
  # Job 5: Pruebas Unitarias
  # ------------------------------------------------------------------
  tests:
    name: Unit & Smoke Tests
    runs-on: ubuntu-latest
    needs: [lint-format-sast, dependency-scan, iac-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Instalar y Correr Pruebas de Python
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pip install -r services/api/requirements.txt
          pip install pytest
          pytest -q services/api/tests/
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Construir Frontend (smoke test)
        run: |
          cd services/frontend
          if [ -f "index.html" ]; then echo "index.html encontrado."; else exit 1; fi

# ------------------------------------------------------------------
  # Job 6: ConstrucciÃ³n y Escaneo (Docker Hub) - CORREGIDO
  # ------------------------------------------------------------------
  build-and-scan-images:
    name: Build, Scan & Push (Docker Hub)
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Restore Trivy DB Cache
        uses: actions/cache@v4
        with:
          path: .trivy
          key: trivy-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: trivy-db-${{ runner.os }}

      - name: Build, scan and push
        run: |
          # 1. Definir nombres de imagen
          API_IMG="mauriciovergara/centinela-api:${{ github.run_id }}"
          FRONT_IMG="mauriciovergara/centinela-frontend:${{ github.run_id }}"
          SCRAPER_IMG="mauriciovergara/centinela-scraper:${{ github.run_id }}"

          # 2. Construir imÃ¡genes (Build)
          docker build -t $API_IMG -f services/api/Dockerfile services/api
          docker build -t $FRONT_IMG -f services/frontend/Dockerfile services/frontend
          docker build -t $SCRAPER_IMG -f services/scraper/Dockerfile services/scraper

          # 3. Instalar Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          mkdir -p reports
          
          # --- CORRECCIÃ“N AQUÃ: Descargar la plantilla HTML ---
          wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

          # 4. Descargar Base de Datos
          trivy image --download-db-only --cache-dir .trivy

          # 5. Escanear API
          echo ">>> Escaneando API..."
          trivy image --cache-dir .trivy --format json --output reports/trivy-api.json \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL --exit-code 0 $API_IMG

          # Usamos @html.tpl (el archivo que acabamos de bajar)
          trivy image --cache-dir .trivy --format template --template "@html.tpl" --output reports/trivy-api.html \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL $API_IMG

          # 6. Escanear Frontend
          echo ">>> Escaneando Frontend..."
          trivy image --cache-dir .trivy --format json --output reports/trivy-frontend.json \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL --exit-code 0 $FRONT_IMG

          trivy image --cache-dir .trivy --format template --template "@html.tpl" --output reports/trivy-frontend.html \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL $FRONT_IMG

          # 7. Escanear Scraper
          echo ">>> Escaneando Scraper..."
          trivy image --cache-dir .trivy --format json --output reports/trivy-scraper.json \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL --exit-code 0 $SCRAPER_IMG

          trivy image --cache-dir .trivy --format template --template "@html.tpl" --output reports/trivy-scraper.html \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL $SCRAPER_IMG
          
          # 8. Comprimir reportes
          (cd reports && zip -r ../trivy-reports-${{ github.run_id }}.zip . || true)

          # 9. Subir imÃ¡genes a Docker Hub
          docker push $API_IMG
          docker push $FRONT_IMG
          docker push $SCRAPER_IMG

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            reports/*.json
            reports/*.html
            trivy-reports-*.zip

  # ------------------------------------------------------------------
  # Job 7: Escaneo DinÃ¡mico (DAST)
  # ------------------------------------------------------------------
  dast:
    name: DAST â€” OWASP ZAP
    runs-on: ubuntu-latest
    needs: build-and-scan-images
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: read
    outputs:
      dast_critical: ${{ steps.set-dast-output.outputs.dast_critical }}
      dast_high: ${{ steps.set-dast-output.outputs.dast_high }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create .env file
        run: |
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres" >> .env
          echo "POSTGRES_DB=centinela" >> .env
          echo "DATABASE_URL=postgresql://postgres:postgres@db:5432/centinela" >> .env
          echo "REDIS_HOST=redis" >> .env
          echo "NEWS_API_KEY=dummy_key_for_ci" >> .env

      - name: Run application stack (PULL from Docker Hub)
        run: |
          export API_IMAGE="mauriciovergara/centinela-api:${{ github.run_id }}"
          export FRONTEND_IMAGE="mauriciovergara/centinela-frontend:${{ github.run_id }}"
          export SCRAPER_IMAGE="mauriciovergara/centinela-scraper:${{ github.run_id }}"

          docker pull $API_IMAGE
          docker pull $FRONTEND_IMAGE
          docker pull $SCRAPER_IMAGE
          
          docker compose -f docker-compose.yml up -d --build
          sleep 30

      - name: Run ZAP Baseline Scan
        run: |
          mkdir -p reports
          FRONTEND_CID=$(docker compose ps -q frontend)
          if [ -z "$FRONTEND_CID" ]; then echo "ERROR: no se encontrÃ³ 'frontend'"; exit 1; fi
          NETWORK_NAME=$(docker inspect --format '{{range $k,$v := .NetworkSettings.Networks}}{{$k}} {{end}}' $FRONTEND_CID | awk '{print $1}')

          docker run --rm --network "$NETWORK_NAME" busybox sh -c 'until wget -qO- http://frontend:80 >/dev/null 2>&1; do echo waiting...; sleep 5; done'

          docker run --rm -u 0 --network "$NETWORK_NAME" --name zap_scanner \
            -v "$(pwd)/reports":/zap/wrk -w /zap/wrk \
            ghcr.io/zaproxy/zaproxy zap-baseline.py \
              -t http://frontend:80 \
              -r report_dast_zap.html \
              -J report_dast_zap.json || true

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reporte-dast-zap
          path: reports/report_dast_zap.*

      - name: Parse ZAP JSON & set outputs
        id: set-dast-output
        if: always()
        run: |
          set -euo pipefail || true
          if ! command -v jq >/dev/null 2>&1; then sudo apt-get update -y && sudo apt-get install -y jq || true; fi
          if [ ! -f reports/report_dast_zap.json ]; then
             echo "dast_critical=0" >> $GITHUB_OUTPUT
             echo "dast_high=0" >> $GITHUB_OUTPUT
             exit 0
          fi
          critical=$(jq '[.site[]?.alerts[]? | select(.risk=="High" or .risk=="Critical")] | length' reports/report_dast_zap.json || echo 0)
          high=$(jq '[.site[]?.alerts[]? | select(.risk=="High")] | length' reports/report_dast_zap.json || echo 0)
          echo "dast_critical=$critical" >> $GITHUB_OUTPUT
          echo "dast_high=$high" >> $GITHUB_OUTPUT

      - name: Stop application stack
        if: always()
        run: docker compose -f docker-compose.yml down --volumes --remove-orphans

  # ------------------------------------------------------------------
  # Job 8: Publicar Etiquetas Latest (Docker Hub)
  # ------------------------------------------------------------------
  publish-and-deploy:
    name: Publish ':latest' on Docker Hub
    runs-on: ubuntu-latest
    needs: dast
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - run: |
          for SERVICE in api frontend scraper; do
            IMG_ID="mauriciovergara/centinela-$SERVICE"
            docker pull $IMG_ID:${{ github.run_id }}
            docker tag  $IMG_ID:${{ github.run_id }} $IMG_ID:latest
            docker push $IMG_ID:latest
          done

  # ------------------------------------------------------------------
  # Job 9: Limpieza
  # ------------------------------------------------------------------
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: publish-and-deploy
    if: always()
    steps:
      - run: docker image prune -af || true

  # ------------------------------------------------------------------
  # Job 10: Despliegue a ProducciÃ³n (SIMULADO Y DETALLADO)
  # ------------------------------------------------------------------
  deploy-to-production:
    name: "Deploy to Production (SIMULATED)" 
    runs-on: ubuntu-latest
    needs: publish-and-deploy
    # Opcional: environment para aprobaciÃ³n manual
    environment: 
      name: production
      url: http://centinela-demo.uniminuto.edu
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      SIM_DEPLOY_USER: "ubuntu"
      SIM_DEPLOY_HOST: "123.45.67.89"

    steps:
      - name: 1. Checkout (Obtener cÃ³digo fuente)
        uses: actions/checkout@v4

      - name: 2. (SIMULADO) Configurar clave SSH
        run: |
          echo "Simulando configuraciÃ³n de clave SSH..."
          echo "Se usarÃ­a 'secrets.DEPLOY_KEY' para autenticarse."
          mkdir -p ~/.ssh
          echo "Directorio ~/.ssh creado (simulado)."

      - name: 3. (SIMULADO) AÃ±adir IP del host a known_hosts
        run: |
          echo "Simulando ssh-keyscan -H $SIM_DEPLOY_HOST >> ~/.ssh/known_hosts"
          echo "Host de producciÃ³n aÃ±adido a known_hosts (simulado)."

      - name: 4. (SIMULADO) Desplegar en el Servidor
        run: |
          echo "SimulaciÃ³n de despliegue en $SIM_DEPLOY_USER@$SIM_DEPLOY_HOST..."
          echo "--------------------------------------------------------"
          echo "PASO 1: Copiar docker-compose.yml al servidor"
          echo "COMANDO: scp -o StrictHostKeyChecking=no docker-compose.yml $SIM_DEPLOY_USER@$SIM_DEPLOY_HOST:/home/ubuntu/centinela/"
          echo ""
          echo "PASO 2: Ejecutar comandos de despliegue en el servidor vÃ­a SSH"
          echo "COMANDO: ssh -o StrictHostKeyChecking=no $SIM_DEPLOY_USER@$SIM_DEPLOY_HOST"
          echo "   > cd /home/ubuntu/centinela"
          # Actualizado para Docker Hub
          echo "   > echo '***' | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin"
          echo "   > docker compose pull"
          echo "   > docker compose up -d"
          echo "   > docker image prune -af"
          echo "--------------------------------------------------------"
          echo "Â¡Despliegue simulado exitosamente!"

# ------------------------------------------------------------------
  # Job 11: Publicar Reportes Web (GitHub Pages)
  # ------------------------------------------------------------------
  deploy-reports-web:
    name: Publish Security Reports to Web
    runs-on: ubuntu-latest
    needs: [build-and-scan-images, dast] # Espera a que terminen los escaneos
    if: always() # Ejecutar aunque se encuentren vulnerabilidades
    permissions:
      contents: write # Permiso para actualizar la rama web
    steps:
      - uses: actions/checkout@v4

      # 1. Descargar los reportes guardados en los pasos anteriores
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: trivy-reports
          path: public/reports
      
      - name: Download DAST Report
        uses: actions/download-artifact@v4
        with:
            name: reporte-dast-zap
            path: public/reports

      # 2. Crear un Ãndice (MenÃº Principal)
      - name: Generate Index Page
        run: |
          cd public
          echo "<html><head><title>Centinela Security Dashboard</title>" > index.html
          echo "<style>body{font-family:sans-serif; padding:20px;} a{display:block; margin:10px 0; font-size:18px;} .card{border:1px solid #ddd; padding:15px; border-radius:8px; max-width:600px; margin-bottom:10px;}</style>" >> index.html
          echo "</head><body>" >> index.html
          echo "<h1>ğŸ›¡ï¸ Reportes de Seguridad - Proyecto Centinela</h1>" >> index.html
          echo "<p>Ãšltima actualizaciÃ³n: $(date)</p><hr>" >> index.html
          
          echo "<h3>ğŸ³ Contenedores (Trivy)</h3>" >> index.html
          echo "<div class='card'><a href='reports/trivy-api.html'>ğŸ“„ Reporte API</a></div>" >> index.html
          echo "<div class='card'><a href='reports/trivy-frontend.html'>ğŸ“„ Reporte Frontend</a></div>" >> index.html
          echo "<div class='card'><a href='reports/trivy-scraper.html'>ğŸ“„ Reporte Scraper</a></div>" >> index.html
          
          echo "<h3>ğŸ”¥ Ataque DinÃ¡mico (OWASP ZAP)</h3>" >> index.html
          echo "<div class='card'><a href='reports/report_dast_zap.html'>ğŸ“„ Reporte DAST</a></div>" >> index.html
          
          echo "</body></html>" >> index.html

      # 3. Publicar en la rama gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: false # Reemplaza el sitio viejo con el nuevo