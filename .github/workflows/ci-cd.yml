# .github/workflows/ci-cd-full.yml
name: CI/CD Full — Centinela (DevSecOps)

# Ejecutar en push a main y en PRs
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:

  setup-cache:
    name: Prepare & Cache (pip / npm)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip packages
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/services/**/requirements.txt') }}-${{ runner.os }}
          restore-keys: |
            pip-${{ runner.os }}

      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v4
        with:
          path: |
            services/frontend/node_modules
            ~/.npm
          key: node-${{ hashFiles('services/frontend/**/package-lock.json') }}-${{ runner.os }}
          restore-keys: |
            node-${{ runner.os }}

  lint-format-sast:
    name: Lint / Format / SAST
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install black flake8 bandit semgrep
      - run: black --check services || true
      - run: flake8 services || true
      - run: bandit -r services/api -lll || true
      - run: semgrep --config ./.semgrep/basic-rules.yml || true

  dependency-scan:
    name: Dependency & Filesystem Scan (Trivy SBOM)
    runs-on: ubuntu-latest
    needs: lint-format-sast
    steps:
      - uses: actions/checkout@v4
      - run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - run: trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress . || true

  tests:
    name: Unit & Smoke Tests
    runs-on: ubuntu-latest
    needs: dependency-scan
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          pip install -r services/api/requirements.txt
          pip install pytest
          pytest -q || true
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          cd services/frontend
          npm install
          npm run build --if-present

  build-and-scan-images:
    name: Build Docker images & Scan
    runs-on: ubuntu-latest
    needs: tests
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        if: ${{ secrets.GHCR_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - run: docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:api-${{ github.run_id }} -f services/api/Dockerfile services/api
      - run: docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:frontend-${{ github.run_id }} -f services/frontend/Dockerfile services/frontend
      - run: docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:scraper-${{ github.run_id }} -f services/scraper/Dockerfile services/scraper

      - run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - run: trivy image --severity HIGH,CRITICAL --exit-code 1 ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:api-${{ github.run_id }} || true
      - run: trivy image --severity HIGH,CRITICAL --exit-code 1 ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:frontend-${{ github.run_id }} || true
      - run: trivy image --severity HIGH,CRITICAL --exit-code 1 ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:scraper-${{ github.run_id }} || true

  dast:
    name: DAST — OWASP ZAP
    runs-on: ubuntu-latest
    needs: build-and-scan-images
    steps:
      - uses: actions/checkout@v4
      - run: docker-compose -f docker-compose.yml up -d --build && sleep 12
      - uses: zaproxy/action-baseline@v0.8.0
        with:
          target: 'http://localhost:3000'
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - run: mkdir -p reports && mv zap_report.html reports/ || true
      - run: docker-compose -f docker-compose.yml down --volumes --remove-orphans

  publish-and-deploy:
    name: Publish images & Deploy
    runs-on: ubuntu-latest
    needs: dast
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        if: ${{ secrets.GHCR_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:api-${{ github.run_id }}  ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:api-latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:api-latest

      - run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:frontend-${{ github.run_id }}  ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:frontend-latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:frontend-latest

      - run: |
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:scraper-${{ github.run_id }}  ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:scraper-latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:scraper-latest

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: publish-and-deploy
    if: always()
    steps:
      - run: docker image prune -af || true
