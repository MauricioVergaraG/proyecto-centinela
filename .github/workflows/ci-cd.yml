name: CI/CD Full - Centinela (DevSecOps)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:

  setup-cache:
    name: Prepare & Cache (pip / npm)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip packages
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/services/**/requirements.txt') }}-${{ runner.os }}
          restore-keys: |
            pip-${{ runner.os }}

      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v4
        with:
          path: |
            services/frontend/node_modules
            ~/.npm
          key: node-${{ hashFiles('services/frontend/**/package-lock.json') }}-${{ runner.os }}
          restore-keys: |
            node-${{ runner.os }}

  lint-format-sast:
    name: Lint / Format / SAST
    runs-on: ubuntu-latest
    needs: setup-cache
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - run: |
          python -m pip install --upgrade pip
          pip install black flake8 bandit semgrep

      - run: black --check services
      - run: flake8 services
      - run: bandit -r services/api -lll
      - run: semgrep --config ./.semgrep/basic-rules.yml

  dependency-scan:
    name: Dependency & Filesystem Scan (Trivy SBOM)
    runs-on: ubuntu-latest
    needs: lint-format-sast
    steps:
      - uses: actions/checkout@v4

      - run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      - run: trivy fs --severity HIGH,CRITICAL --exit-code 1 --no-progress .

  tests:
    name: Unit & Smoke Tests
    runs-on: ubuntu-latest
    needs: dependency-scan
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - run: |
          pip install -r services/api/requirements.txt
          pip install pytest
          pytest -q

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: |
          cd services/frontend
          npm install
          npm run build --if-present


  build-and-scan-images:
    name: Build, Scan & Push Versioned Images
    runs-on: ubuntu-latest
    needs: tests
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        if: env.GHCR_TOKEN != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Build, scan and push images
        run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')

          docker build -t $REGISTRY/$IMAGE_NS:api-${{ github.run_id }} -f services/api/Dockerfile services/api
          docker build -t $REGISTRY/$IMAGE_NS:frontend-${{ github.run_id }} -f services/frontend/Dockerfile services/frontend
          docker build -t $REGISTRY/$IMAGE_NS:scraper-${{ github.run_id }} -f services/scraper/scraper/Dockerfile services/scraper/scraper

          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          trivy image --severity HIGH,CRITICAL --exit-code 1 $REGISTRY/$IMAGE_NS:api-${{ github.run_id }} || true
          trivy image --severity HIGH,CRITICAL --exit-code 1 $REGISTRY/$IMAGE_NS:frontend-${{ github.run_id }} || true
          trivy image --severity HIGH,CRITICAL --exit-code 1 $REGISTRY/$IMAGE_NS:scraper-${{ github.run_id }} || true

          docker push $REGISTRY/$IMAGE_NS:api-${{ github.run_id }}
          docker push $REGISTRY/$IMAGE_NS:frontend-${{ github.run_id }}
          docker push $REGISTRY/$IMAGE_NS:scraper-${{ github.run_id }}

  dast:
    name: DAST â€” OWASP ZAP
    runs-on: ubuntu-latest
    needs: build-and-scan-images
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        if: env.GHCR_TOKEN != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - run: docker-compose -f docker-compose.yml pull
      - run: docker-compose -f docker-compose.yml up -d && sleep 20

      - uses: zaproxy/action-baseline@v0.8.0
        with:
          target: 'http://localhost:3000'
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - run: mkdir -p reports && mv zap_report.html reports/ || true
      - run: docker-compose -f docker-compose.yml down --volumes --remove-orphans

  publish-and-deploy:
    name: Publish ':latest' tags
    runs-on: ubuntu-latest
    needs: dast
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAMESPACE: ${{ github.repository }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
    steps:
      - name: Login GHCR
        if: env.GHCR_TOKEN != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ env.GHCR_TOKEN }}

      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          docker pull $REGISTRY/$IMAGE_NS:api-${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS:api-${{ github.run_id }}  $REGISTRY/$IMAGE_NS:api-latest
          docker push $REGISTRY/$IMAGE_NS:api-latest

      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          docker pull $REGISTRY/$IMAGE_NS:frontend-${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS:frontend-${{ github.run_id }}  $REGISTRY/$IMAGE_NS:frontend-latest
          docker push $REGISTRY/$IMAGE_NS:frontend-latest

      - run: |
          IMAGE_NS=$(echo "${IMAGE_NAMESPACE}" | tr '[:upper:]' '[:lower:]')
          docker pull $REGISTRY/$IMAGE_NS:scraper-${{ github.run_id }}
          docker tag  $REGISTRY/$IMAGE_NS:scraper-${{ github.run_id }}  $REGISTRY/$IMAGE_NS:scraper-latest
          docker push $REGISTRY/$IMAGE_NS:scraper-latest

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: publish-and-deploy
    if: always()
    steps:
      - run: docker image prune -af || true
