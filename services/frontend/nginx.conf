# Configuración simple de Nginx para una SPA (Single Page Application)
server {
  listen 80;
  server_name  localhost;

  # Ruta raíz donde están tus archivos (ej. index.html)
  root   /usr/share/nginx/html;
  index  index.html index.htm;

  # --- ¡AQUÍ ESTÁ LA REMEDIACIÓN DE DAST! ---

  # 1. Arregla: "Missing Anti-clickjacking Header"
  add_header X-Frame-Options "SAMEORIGIN" always;

  # 2. Arregla: "X-Content-Type-Options Header Missing"
  add_header X-Content-Type-Options "nosniff" always;

  # 3. Arregla: "Server Leaks Version Information"
  server_tokens off;

  # 4. Arregla: "Content Security Policy (CSP) Header Not Set"
  #    Esta es una política BÁSICA. En un proyecto real, sería más estricta.
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; object-src 'none'; frame-ancestors 'self';" always;

  # 5. Arregla: "Permissions Policy Header Not Set"
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

  # 6. Mejora: Mitigaciones de aislamiento (Spectre-related warnings)
  # Cross-Origin-Opener-Policy y Cross-Origin-Embedder-Policy habilitan aislamiento
  add_header Cross-Origin-Opener-Policy "same-origin" always;
  add_header Cross-Origin-Embedder-Policy "require-corp" always;

  # 7. Políticas adicionales recomendadas
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  # HSTS (solo efectivo en HTTPS; es seguro definirlo pero aplica en TLS)
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

  # Cabeceras adicionales recomendadas para pasar chequeos de scanners
  add_header Cross-Origin-Resource-Policy "same-origin" always;
  add_header X-Permitted-Cross-Domain-Policies "none" always;
  add_header X-Download-Options "noopen" always;
  # X-XSS-Protection está deprecado en navegadores modernos, pero algunos scanners lo buscan.
  add_header X-XSS-Protection "0" always;

  # 8. Cache control: evitar cache para la página principal (reduce riesgos de contenido stale)
  # Mantén assets estáticos cacheables para rendimiento; solo index.html será no-store

  # --- FIN DE LA REMEDIACIÓN ---

  # Esta regla asegura que si el usuario refresca la página (ej. /pagina2),
  # React/Vue maneje la ruta en lugar de Nginx.
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Evitar cache del HTML principal
  location = /index.html {
    # Evitar cache agresivo pero permitir revalidación (reduce 'Non-Storable Content' warnings)
    add_header Cache-Control "no-cache, must-revalidate" always;
  }

  # Configuración para los archivos estáticos (JS, CSS, etc.)
  location ~ \.(css|js|png|jpg|gif|ico)$ {
    expires 1d; # Cache de 1 día
  }

}
