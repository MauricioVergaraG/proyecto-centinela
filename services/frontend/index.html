<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centinela - Grupo 3 DevSecOps</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* TEMA CLARO */
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; color: #1e293b; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        /* Tarjetas con fondo blanco y sombra suave */
        .card-white { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .animate-in { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-full">

    <div id="root"></div>

    <script type="text/babel">
        // --- DASHBOARD (GR√ÅFICAS) ---
        function StatsDashboard({ results }) {
            const canvasRef = React.useRef(null);
            
            React.useEffect(() => {
                if (!canvasRef.current || results.length === 0) return;
                
                const safe = results.filter(r => r.score < 30).length;
                const medium = results.filter(r => r.score >= 30 && r.score < 70).length;
                const danger = results.filter(r => r.score >= 70).length;

                const chart = new Chart(canvasRef.current, {
                    type: 'doughnut',
                    data: {
                        labels: ['Seguro', 'Sospechoso', 'Fake News'],
                        datasets: [{
                            data: [safe, medium, danger],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#334155' } } } }
                });
                return () => chart.destroy();
            }, [results]);

            return (
                <div className="card-white rounded-xl p-6 flex flex-col md:flex-row items-center justify-between mb-8">
                    <div className="mb-4 md:mb-0">
                        <h2 className="text-2xl font-bold text-slate-800 mb-1">Estado de la Red</h2>
                        <p className="text-slate-500 text-sm">Monitoreo de desinformaci√≥n en tiempo real</p>
                        <div className="mt-4 flex gap-4 text-center">
                            <div className="bg-slate-100 p-3 rounded-lg border border-slate-200"><div className="text-2xl font-bold text-slate-700">{results.length}</div><div className="text-xs text-slate-500">URLs Analizadas</div></div>
                            <div className="bg-red-50 p-3 rounded-lg border border-red-100"><div className="text-2xl font-bold text-red-600">{results.filter(r => r.score >= 70).length}</div><div className="text-xs text-red-400">Amenazas</div></div>
                        </div>
                    </div>
                    <div className="h-40 w-full md:w-64">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        // --- TARJETA DE RESULTADO ---
        function AnalysisCard({ article, isMainResult }) {
            let reasons = [];
            let cleanBody = article.body;
            
            if (article.body && article.body.includes("REPORT_METADATA:")) {
                const parts = article.body.split(":::");
                try {
                    reasons = JSON.parse(parts[0].replace("REPORT_METADATA:", ""));
                    cleanBody = parts[1];
                } catch (e) { console.error("Error parsing", e); }
            }

            // Estilos claros
            let theme = { bg: "bg-emerald-50", border: "border-emerald-200", text: "text-emerald-700", icon: "üõ°Ô∏è", label: "CONFIABLE" };
            if (article.score >= 30) theme = { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-700", icon: "‚ö†Ô∏è", label: "DUDOSO" };
            if (article.score >= 70) theme = { bg: "bg-red-50", border: "border-red-200", text: "text-red-700", icon: "üö®", label: "ALTO RIESGO" };

            // Generar PDF
            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                // ... (L√≥gica PDF igual) ...
                doc.setFontSize(20); doc.text("REPORTE FORENSE - CENTINELA", 20, 20);
                doc.setFontSize(12); doc.text(`URL: ${article.permalink}`, 20, 40);
                doc.text(`VEREDICTO: ${theme.label} (${article.score}%)`, 20, 60);
                doc.text("EVIDENCIA DETECTADA:", 20, 80);
                reasons.forEach((r, i) => doc.text(`- ${r}`, 25, 90 + (i*7)));
                doc.save("reporte_forense.pdf");
            };

            return (
                <div className={`animate-in rounded-xl border ${theme.border} ${theme.bg} p-6 mb-4 relative overflow-hidden shadow-sm`}>
                    {isMainResult && <div className="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">RESULTADO ACTUAL</div>}
                    
                    <div className="flex justify-between items-start">
                        <div className="flex gap-4">
                            <div className="text-4xl">{theme.icon}</div>
                            <div>
                                <h3 className={`text-xl font-bold ${theme.text}`}>{theme.label}</h3>
                                <p className="text-slate-500 text-sm font-mono uppercase tracking-wider">{article.author}</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <span className={`text-4xl font-black ${theme.text}`}>{article.score}%</span>
                            <p className="text-[10px] text-slate-500 uppercase">Score</p>
                        </div>
                    </div>

                    {reasons.length > 0 && (
                        <div className="mt-4 flex flex-wrap gap-2">
                            {reasons.map((r, i) => (
                                <span key={i} className="px-2 py-1 bg-white border border-slate-200 rounded text-xs text-slate-600 font-mono shadow-sm">
                                    üîç {r}
                                </span>
                            ))}
                        </div>
                    )}

                    <div className="mt-4 p-4 bg-white/60 rounded-lg border border-slate-200/50">
                        <p className="text-slate-600 text-sm italic line-clamp-3 font-serif">"{cleanBody}"</p>
                    </div>

                    <div className="mt-4 flex justify-between items-center border-t border-slate-200 pt-4">
                        <a href={article.permalink} target="_blank" className="text-blue-600 hover:text-blue-800 text-sm font-bold flex items-center gap-1">
                            üîó Ver Fuente
                        </a>
                        <button onClick={downloadPDF} className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-all shadow-md">
                            üìÑ Descargar Informe PDF
                        </button>
                    </div>
                </div>
            );
        }

        function App() {
            const [url, setUrl] = React.useState("");
            const [results, setResults] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const [currentUrl, setCurrentUrl] = React.useState(null);

            const fetchResults = async () => {
                try {
                    const res = await fetch('http://localhost:8000/results?limit=50');
                    if (res.ok) setResults(await res.json());
                } catch (e) { console.error(e); }
            };

            React.useEffect(() => {
                fetchResults();
                const interval = setInterval(fetchResults, 4000);
                return () => clearInterval(interval);
            }, []);

            const handleAnalyze = async (e) => {
                e.preventDefault();
                setLoading(true);
                setCurrentUrl(url);
                try {
                    await fetch('http://localhost:8000/analyze', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url })
                    });
                    setTimeout(fetchResults, 1000);
                } catch (e) {} 
                setLoading(false);
                setUrl("");
            };

            // --- FUNCI√ìN BORRAR HISTORIAL (Visual) ---
            const clearHistory = () => {
                setResults([]); // Limpia la vista actual
                setCurrentUrl(null);
                alert("Vista limpia. Nota: Para borrar la Base de Datos real, contacte al administrador del backend.");
            };

            const mainResult = currentUrl ? results.find(r => r.permalink === currentUrl) : null;
            const history = currentUrl ? results.filter(r => r.permalink !== currentUrl) : results;

            return (
                <div className="container mx-auto px-4 py-8 max-w-5xl">
                    
                    {/* --- HEADER NUEVO --- */}
                    <div className="flex flex-col md:flex-row items-center gap-6 mb-10 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        {/* LOGO: Aseg√∫rate de que logo.png est√© en la carpeta src o public */}
                        <div className="w-24 h-24 shrink-0">
                            <img src="./logo.png" alt="Centinela Logo" className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} />
                        </div>
                        
                        <div className="text-center md:text-left flex-1">
                            <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight mb-1">CENTINELA</h1>
                            <p className="text-blue-600 font-bold text-sm tracking-wide mb-2">SISTEMA DE AN√ÅLISIS FORENSE DIGITAL v3.0</p>
                            
                            <div className="h-px bg-slate-200 w-full my-3"></div>
                            
                            <p className="text-slate-600 font-medium">App del Grupo 3 para DevSecOps</p>
                            <p className="text-slate-500 text-sm">Especializaci√≥n en Ciberseguridad ‚Ä¢ uniminuto.edu.co</p>
                        </div>
                    </div>

                    <StatsDashboard results={results} />

                    {/* BUSCADOR */}
                    <div className="card-white p-8 rounded-2xl mb-10 relative overflow-hidden bg-white">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-indigo-600 to-cyan-500"></div>
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Iniciar Nuevo Caso</h2>
                        <form onSubmit={handleAnalyze} className="flex flex-col md:flex-row gap-4">
                            <input 
                                type="url" 
                                value={url} 
                                onChange={e => setUrl(e.target.value)}
                                placeholder="Ingrese URL sospechosa (ej: http://...)"
                                className="w-full bg-slate-50 border border-slate-300 rounded-xl px-6 py-4 text-slate-800 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all font-medium"
                                required 
                            />
                            <button disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all disabled:opacity-50 min-w-[150px]">
                                {loading ? "Analizando..." : "ANALIZAR"}
                            </button>
                        </form>
                        <div className="mt-4 flex flex-wrap gap-2">
                             <button onClick={() => setUrl("http://simulacro-fake.com")} className="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full border border-red-200 hover:bg-red-100 font-semibold transition-colors">üö® Cargar Simulacro</button>
                             <button onClick={() => setUrl("https://www.bbc.com")} className="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full border border-green-200 hover:bg-green-100 font-semibold transition-colors">‚úÖ Cargar BBC</button>
                        </div>
                    </div>

                    {mainResult && (
                        <div className="mb-12 animate-in">
                            <h3 className="text-blue-700 font-bold mb-4 flex items-center gap-2 text-lg">
                                <span className="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></span>
                                RESULTADO DE TU AN√ÅLISIS
                            </h3>
                            <AnalysisCard article={mainResult} isMainResult={true} />
                        </div>
                    )}

                    <div>
                        <div className="flex justify-between items-end border-b border-slate-200 pb-2 mb-4">
                            <h3 className="text-slate-500 font-bold uppercase text-sm tracking-widest">
                                Base de Datos Global
                            </h3>
                            <button onClick={clearHistory} className="text-red-500 hover:text-red-700 text-xs font-bold flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                LIMPIAR PANTALLA
                            </button>
                        </div>

                        {history.length === 0 ? (
                            <div className="text-center text-slate-400 py-10 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                                Sin datos en vista.
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 gap-4">
                                {history.map(item => <AnalysisCard key={item.id} article={item} isMainResult={false} />)}
                            </div>
                        )}
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>